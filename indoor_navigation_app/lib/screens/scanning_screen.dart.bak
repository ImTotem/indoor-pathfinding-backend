import 'package:flutter/material.dart';
import 'package:flutter/rendering.dart';
import 'package:camera/camera.dart';
import 'dart:ui' as ui;
import 'dart:convert';
import 'dart:async';
import 'dart:typed_data';

import '../services/api_service.dart';
import '../services/streaming_uploader.dart';
import '../services/camera_service.dart';
import '../services/sensor_service.dart';
import '../models/frame_data.dart';
import '../config/app_config.dart';
import '../config/constants.dart';
import '../utils/image_processor.dart';
import '../utils/image_converter.dart';
import '../utils/frame_quality_checker.dart';
import '../widgets/status_bar.dart';
import '../widgets/crosshair_painter.dart';
import '../widgets/action_button.dart';
import 'processing_screen.dart';

class ScanningScreen extends StatefulWidget {
  @override
  _ScanningScreenState createState() => _ScanningScreenState();
}

class _ScanningScreenState extends State<ScanningScreen> {
  final CameraService _cameraService = CameraService();
  final SensorService _sensorService = SensorService();
  final FrameQualityChecker _qualityChecker = FrameQualityChecker();
  final GlobalKey _repaintKey = GlobalKey();

  StreamingUploader? _uploader;
  Timer? _captureTimer;

  String _sessionId = '';
  bool _isScanning = false;
  bool _isPaused = false;
  bool _isConnected = true;
  bool _isCapturing = false;

  int _frameCount = 0;
  int _acceptedFrameCount = 0;
  int _rejectedFrameCount = 0;
  int _uploadQueueSize = 0;

  double _currentFps = 0.0;
  DateTime _lastFrameTime = DateTime.now();

  @override
  void initState() {
    super.initState();
    _initializeServices();
  }

  Future<void> _initializeServices() async {
    _sensorService.startListening();
    setState(() {});
  }

  @override
  Widget build(BuildContext context) {
    return Scaffold(
      backgroundColor: Colors.black,
      body: Stack(
        children: [
          // RepaintBoundary로 AR 뷰 감싸기 (캡처용)
          RepaintBoundary(
            key: _repaintKey,
            child: ARView(
              onARViewCreated: _onARViewCreated,
              planeDetectionConfig: PlaneDetectionConfig.horizontalAndVertical,
            ),
          ),

          StatusBar(
            isScanning: _isScanning,
            isConnected: _isConnected,
            hasCalibration: _arService.hasCalibration,
            cameraIntrinsics: _arService.cameraIntrinsics,
            currentFps: _currentFps,
            frameCount: _acceptedFrameCount,
            uploadedFrames: _uploader?.totalFramesSent ?? 0,
            uploadQueueSize: _uploadQueueSize,
            hasAccel: _sensorService.hasAccel,
            hasGyro: _sensorService.hasGyro,
            hasMagnet: _sensorService.hasMagnet,
          ),

          if (_isScanning && !_isPaused) _buildCrosshair(),

          _buildBottomControls(),
        ],
      ),
    );
  }

  Widget _buildCrosshair() {
    return Center(
      child: Container(
        width: AppConstants.crosshairSize,
        height: AppConstants.crosshairSize,
        child: CustomPaint(painter: CrosshairPainter()),
      ),
    );
  }

  Widget _buildBottomControls() {
    return Positioned(
      bottom: 0,
      left: 0,
      right: 0,
      child: SafeArea(
        child: Container(
          padding: EdgeInsets.all(20),
          decoration: BoxDecoration(
            gradient: LinearGradient(
              begin: Alignment.topCenter,
              end: Alignment.bottomCenter,
              colors: [
                Colors.transparent,
                Colors.black.withOpacity(AppConstants.bottomBarOpacity),
              ],
            ),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              Container(
                padding: EdgeInsets.symmetric(horizontal: 16, vertical: 8),
                decoration: BoxDecoration(
                  color: Colors.white.withOpacity(0.1),
                  borderRadius: BorderRadius.circular(20),
                ),
                child: Text(
                  _getStatusMessage(),
                  style: TextStyle(color: Colors.white, fontSize: 14),
                  textAlign: TextAlign.center,
                ),
              ),
              SizedBox(height: 20),
              _buildActionButtons(),
            ],
          ),
        ),
      ),
    );
  }

  String _getStatusMessage() {
    if (_isPaused) return AppConstants.msgPaused;
    if (_isScanning) return AppConstants.msgScanning;
    return AppConstants.msgReady;
  }

  Widget _buildActionButtons() {
    return Row(
      mainAxisAlignment: MainAxisAlignment.center,
      children: [
        if (!_isScanning)
          ActionButton(
            icon: Icons.play_arrow,
            label: '스캔 시작',
            color: Color(AppConstants.colorGreen),
            onPressed: _startScanning,
          ),
        if (_isScanning) ...[
          ActionButton(
            icon: _isPaused ? Icons.play_arrow : Icons.pause,
            label: _isPaused ? '재개' : '일시정지',
            color: Color(AppConstants.colorOrange),
            onPressed: _togglePause,
          ),
          SizedBox(width: 16),
          ActionButton(
            icon: Icons.stop,
            label: '완료',
            color: Color(AppConstants.colorRed),
            onPressed: _stopScanning,
          ),
        ],
      ],
    );
  }

  void _onARViewCreated(
    ARSessionManager sessionManager,
    ARObjectManager objectManager,
    ARAnchorManager anchorManager,
    ARLocationManager locationManager,
  ) {
    _arService.initialize(
        sessionManager, objectManager, anchorManager, locationManager);

    sessionManager.onPlaneOrPointTap = (List<ARHitTestResult> hits) {
      if (hits.isNotEmpty) {
        _arService.updatePoseFromHit(hits.first);
      }
    };
  }

  Future<void> _startScanning() async {
    try {
      _sessionId = await ApiService.startScan();
      print('[Scanning] 세션 시작: $_sessionId');

      _uploader = StreamingUploader(sessionId: _sessionId);
      _qualityChecker.reset();

      setState(() {
        _isScanning = true;
        _isPaused = false;
        _frameCount = 0;
        _acceptedFrameCount = 0;
        _rejectedFrameCount = 0;
      });

      _sensorService.clearBuffer();

      print('[Scanning] 타이머 시작 (${1000 / AppConfig.frameIntervalMs} FPS)');

      // 설정된 FPS로 캡처
      _captureTimer = Timer.periodic(
        Duration(milliseconds: AppConfig.frameIntervalMs),
        (timer) {
          if (!_isPaused) {
            _captureFrame();
          }
        },
      );

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Row(
            children: [
              Icon(Icons.check_circle, color: Colors.white),
              SizedBox(width: 8),
              Text('스캔 시작 - 천천히 움직이며 주변을 촬영하세요'),
            ],
          ),
          backgroundColor: Color(AppConstants.colorGreen),
          behavior: SnackBarBehavior.floating,
        ),
      );
    } catch (e) {
      print('[Scanning] 시작 실패: $e');
      setState(() {
        _isConnected = false;
      });

      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('${AppConstants.errStartFailed}: $e'),
          backgroundColor: Color(AppConstants.colorRed),
          duration: Duration(seconds: 5),
        ),
      );
    }
  }

  void _togglePause() {
    setState(() {
      _isPaused = !_isPaused;
    });
  }

  Future<void> _captureFrame() async {
    if (!_isScanning || _isPaused || _isCapturing) {
      return;
    }

    _isCapturing = true;
    _frameCount++;

    final now = DateTime.now();
    final delta = now.difference(_lastFrameTime).inMilliseconds;
    if (delta > 0) {
      _currentFps = 1000.0 / delta;
    }
    _lastFrameTime = now;

    try {
      final boundary = _repaintKey.currentContext?.findRenderObject()
          as RenderRepaintBoundary?;
      if (boundary == null) {
        _isCapturing = false;
        return;
      }

      final image = await boundary.toImage(pixelRatio: 1.0);
      final byteData = await image.toByteData(format: ui.ImageByteFormat.png);
      if (byteData == null) {
        _isCapturing = false;
        return;
      }

      final pngBytes = byteData.buffer.asUint8List();

      // 품질 검사 (비활성화 가능)
      bool accepted = true;
      if (AppConfig.enableQualityCheck) {
        final qualityResult = _qualityChecker.checkFrameQuality(
          null, // 블러 체크 스킵
          _arService.currentPosition,
          _arService.currentOrientation,
        );
        accepted = qualityResult.isAcceptable;
        if (!accepted) {
          _rejectedFrameCount++;
        }
      }

      if (accepted) {
        _acceptedFrameCount++;
        _qualityChecker.updateLastCapture(
          _arService.currentPosition,
          _arService.currentOrientation,
        );

        // 비동기 처리 (캡처 블로킹 없음)
        _processFrameInBackground(pngBytes);
      }

      _isCapturing = false;
    } catch (e) {
      _isCapturing = false;
    }
  }

  Future<void> _processFrameInBackground(Uint8List pngBytes) async {
    // PNG -> JPEG 압축
    final compressed = await ImageProcessor.compressImage(
      pngBytes,
      width: AppConfig.imageWidth,
      height: AppConfig.imageHeight,
      quality: AppConfig.imageQuality,
    );

    if (compressed == null) {
      print('[Scanning] 이미지 압축 실패');
      return;
    }

    final base64Image = base64Encode(compressed);

    final imuData = _sensorService.getIMUData();
    _sensorService.clearBuffer();

    final frameData = FrameData(
      imageBase64: base64Image,
      position: [
        _arService.currentPosition.x,
        _arService.currentPosition.y,
        _arService.currentPosition.z,
      ],
      orientation: [
        _arService.currentOrientation.x,
        _arService.currentOrientation.y,
        _arService.currentOrientation.z,
        _arService.currentOrientation.w,
      ],
      timestamp: DateTime.now().millisecondsSinceEpoch,
      imuData: imuData,
      cameraIntrinsics: _arService.cameraIntrinsics,
    );

    _uploadFrameAsync(frameData);
  }

  void _uploadFrameAsync(FrameData frameData) async {
    try {
      setState(() {
        _uploadQueueSize++;
      });

      await _uploader?.addFrame(frameData);

      setState(() {
        _uploadQueueSize--;
        _isConnected = true;
      });
    } catch (e) {
      print('[Scanning] 업로드 실패: $e');

      setState(() {
        _uploadQueueSize--;
        _isConnected = false;
      });
    }
  }

  Future<void> _stopScanning() async {
    _captureTimer?.cancel();

    setState(() {
      _isScanning = false;
      _isPaused = false;
    });

    // 최소 프레임 수 체크
    if (_acceptedFrameCount < 30) {
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('최소 30개의 품질 통과 프레임이 필요합니다 (현재: $_acceptedFrameCount개)'),
          backgroundColor: Color(AppConstants.colorOrange),
          duration: Duration(seconds: 3),
        ),
      );

      setState(() {
        _isScanning = true;
      });

      _captureTimer = Timer.periodic(
        Duration(milliseconds: AppConfig.frameIntervalMs),
        (timer) {
          if (!_isPaused) {
            _captureFrame();
          }
        },
      );
      return;
    }

    showDialog(
      context: context,
      barrierDismissible: false,
      builder: (context) => Center(
        child: Container(
          padding: EdgeInsets.all(24),
          decoration: BoxDecoration(
            color: Colors.white,
            borderRadius: BorderRadius.circular(16),
          ),
          child: Column(
            mainAxisSize: MainAxisSize.min,
            children: [
              CircularProgressIndicator(),
              SizedBox(height: 16),
              Text(AppConstants.msgUploading, style: TextStyle(fontSize: 16)),
              SizedBox(height: 8),
              Text('$_uploadQueueSize개 대기 중',
                  style: TextStyle(fontSize: 12, color: Colors.grey)),
            ],
          ),
        ),
      ),
    );

    try {
      while (_uploadQueueSize > 0) {
        await Future.delayed(Duration(milliseconds: 100));
      }

      await _uploader?.finish();

      Navigator.pop(context);
      Navigator.pushReplacement(
        context,
        MaterialPageRoute(
          builder: (context) => ProcessingScreen(sessionId: _sessionId),
        ),
      );
    } catch (e) {
      Navigator.pop(context);
      ScaffoldMessenger.of(context).showSnackBar(
        SnackBar(
          content: Text('${AppConstants.errFinishFailed}: $e'),
          backgroundColor: Color(AppConstants.colorRed),
        ),
      );
    }
  }

  @override
  void dispose() {
    _captureTimer?.cancel();
    _arService.dispose();
    _sensorService.dispose();
    super.dispose();
  }
}
