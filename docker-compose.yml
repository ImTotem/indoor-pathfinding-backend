services:
  rtabmap:
    image: introlab3it/rtabmap_ros:noetic-latest
    container_name: rtabmap
    environment:
      - LD_LIBRARY_PATH=/opt/ros/noetic/lib/x86_64-linux-gnu:/opt/ros/noetic/lib
    volumes:
      - ./be/data:/data
    working_dir: /data
    command: tail -f /dev/null
    restart: unless-stopped
    networks:
      - indoor-network

  web:
    build:
      context: ./be
      dockerfile: Dockerfile
    container_name: indoor-pathfinding-web
    ports:
      - "${SERVER_PORT:-5000}:${SERVER_PORT:-5000}"
    environment:
      # Server Configuration
      - SERVER_PORT=${SERVER_PORT:-5000}
      
      # SLAM Engine Configuration
      - SLAM_ENGINE=rtabmap
      - RTABMAP_PATH=docker://rtabmap
      - LOG_LEVEL=INFO
      
      # PostgreSQL Configuration
      - POSTGRES_HOST=${POSTGRES_HOST:-indoor-pathfinding-db}
      - POSTGRES_PORT=${POSTGRES_PORT:-5432}
      - POSTGRES_DB=${POSTGRES_DB:-indoor_pathfinding}
      - POSTGRES_USER=${POSTGRES_USER:-indoor}
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-indoor1234}
      
      # Fixed Map Mode (optional)
      - USE_FIXED_MAP=${USE_FIXED_MAP:-false}
      - FIXED_MAP_ID=${FIXED_MAP_ID:-}
    volumes:
      - ./be/data:/app/data
      - ${UPLOAD_STORAGE_PATH:?UPLOAD_STORAGE_PATH must be set}:/app/storage/uploads:ro
      - /var/run/docker.sock:/var/run/docker.sock
    depends_on:
      - rtabmap
    restart: unless-stopped
    networks:
      - indoor-network
    command: uvicorn main:app --host 0.0.0.0 --port ${SERVER_PORT:-5000} --workers 1

networks:
  indoor-network:
    external: true
    name: indoor-pathfinding-backend_indoor-network
